# Sentinel - AI Assistant Context

> **Keep this file updated** as features are added, issues are resolved, or architecture changes.

## Overview
Humanitarian news aggregator: RSS feeds ‚Üí ML classification ‚Üí tabbed interface. GitHub Pages frontend + Render API backend.

## Project Structure Rules
- **Frontend at root**: `index.html`, `app.js`, `styles.css` serve from root URL (GitHub Pages requirement)
- **Organized modules**: `src/` (JS modules), `scripts/` (Python), `config/` (settings), `docs/` (documentation), `api/` (Flask)
- **Never nest entry point**: Main HTML/JS always accessible at root URL path

## Path Conventions
- **Frontend imports**: `./src/tabs/tabManager.js` from root, relative paths within `src/`
- **Data fetches**: Absolute from root: `/public/data/articles.json`
- **Python scripts**: Run from repo root, use `config/feeds.json`, `public/data/articles.json`
- **API paths**: Use `os.path.join()` for relative paths from `api/` directory

## Stack
- **Frontend**: Vanilla JS (ES6 modules), GitHub Pages
- **Backend**: Python 3.11, Flask API (Render free tier)
- **Database**: SQLite (`public/data/history.db`)
- **Data**: JSON files + localStorage
- **CI/CD**: GitHub Actions (30min cron)

## Data Flow
```
RSS ‚Üí script_update_live.py ‚Üí articles.json ‚Üí script_classify.py ‚Üí migrate.py ‚Üí script_archive.py
  ‚Üí GitHub Actions PR ‚Üí auto-merge ‚Üí GitHub Pages deploy
```

## Design Language
- **Typography**: Charter serif (body), Fira Sans (UI)
- **Colors**: Navy dark (#1a2332), orange accent (#ff8c42), light mode toggle
- **Layout**: Centered 900px content, full-viewport map, generous whitespace
- **Philosophy**: Information density without clutter. No bloat, no trends, no dark patterns.

## Key Architecture

### Classification (`script_classify.py`)
- **Locations**: 70+ patterns (multi-word: "Sri Lanka")
- **Crisis Types**: Conflict, Humanitarian, Climate, Health, Political
- **Themes**: Keyword extraction + predefined list
- **Keywords**: N-gram extraction, filters stop words
- **Feedback Integration**: Loads `tag_feedback.json`, applies corrections

### Frontend (`src/`)
```
src/
  tabs/
    tabManager.js  - Tab coordinator
    feeds.js       - Feed display + tag UI (üëç ¬± buttons)
    analytics.js   - Stats placeholder
    map.js         - Mapbox GL JS (outdoors-v12)
  utils/helpers.js - Filtering, deduplication
```

### API (`api/`)
- **Deployment**: Render free tier (https://sentinel-cgqj.onrender.com)
- **Endpoints**: `POST /api/feedback` (tag corrections), `GET /api/health`
- **Storage**: `public/data/tag_feedback.json` + GitHub auto-commit
- **Modules**: `app.py` (routes), `config.py` (constants), `models.py` (data), `github_sync.py` (commits)

### Database (`sql/`)
- **Migrations**: Versioned in `sql/migrations/`
- **Pattern**: Recreate-and-copy (SQLite limitation)
- **Schema**: INTEGER timestamps, JSON tags column

## Code Organization Rules
- **Modularize at 150 lines**: Split into logical modules
- **Python API imports**: Absolute (`from config import X`)
- **Configuration separate**: `config/` for JSON, env vars for secrets

## Key Files
- `scripts/script_update_live.py`: Fetches RSS, normalizes dates
- `scripts/script_classify.py`: ML classification + feedback integration
- `scripts/script_archive.py`: SQLite archival
- `scripts/migrate.py`: Schema migrations
- `config/feeds.json`: RSS feed URLs
- `config/feeds_metadata.json`: Source-level tags
- `public/data/tag_feedback.json`: User corrections
- `.github/workflows/update-feeds.yml`: Cron workflow

## Current State

### Completed
‚úÖ RSS fetching + datetime normalization
‚úÖ SQLite with migration system
‚úÖ ML classification (locations, crisis types, themes, keywords)
‚úÖ Tag feedback system (API + UI with ¬± buttons)
‚úÖ Tabbed frontend with localStorage persistence
‚úÖ GitHub Actions with PR auto-merge
‚úÖ Flask API deployed to Render
‚úÖ Mapbox map tab (full-viewport, outdoors-v12)
‚úÖ Dark/light mode toggle
‚úÖ PyGithub integration for auto-commits
‚úÖ API modularization (config, models, github_sync)
‚úÖ Project refactoring (src/, scripts/, config/, docs/ organization)

### Pending
‚è≥ Add GITHUB_TOKEN to Render env vars (for auto-commits)
‚è≥ Test end-to-end: feedback ‚Üí GitHub commit ‚Üí Actions ‚Üí classification
‚è≥ Learning script for tag_feedback.json patterns
‚è≥ Analytics tab implementation
‚è≥ Map geocoding + article markers
‚è≥ Clean up dead RSS feeds
‚è≥ Article ranking/sort options

## Known Issues
- Several RSS feeds failing (Reuters 401, GlobalVoices 404, France24 404)
- Render API cold start ~20-30s (frontend has 30s timeout)

## Development Workflow
1. Work on `dev` branch
2. Test locally: `python3 -m http.server 8000` ‚Üí `http://localhost:8000`
3. Commit + push to dev
4. Create PR dev ‚Üí main
5. After merge: Render auto-deploys API, GitHub Pages deploys frontend

## Testing Commands
```bash
# Data pipeline
python3 scripts/script_update_live.py
python3 scripts/script_classify.py
python3 scripts/migrate.py
python3 scripts/script_archive.py

# Local server
python3 -m http.server 8000
# Visit http://localhost:8000
```

## Deployment
- **Frontend**: GitHub Pages from `main` branch (auto)
- **API**: Render at https://sentinel-cgqj.onrender.com (auto on push)
- **Workflows**: GitHub Actions runs scripts every 30min

## Notes
- `articles.json` regenerated every run (not incremental)
- `history.db` is permanent archive
- Tag feedback syncs to server + localStorage for instant UI
- Classification runs in GitHub Actions
- API uses AbortSignal.timeout(30000) for cold starts
